# Image Nomalizer(이미지 변환 프로그램)

-   해당 프로그램은 이전 직장에서 재직 당시 개발한 프로그램이며 사측의 허락을 받고 업로드하였습니다.

개요 : 작품 이미지를 상품이미지, 웹용이미지, 제작 이미지 등으로 사이즈, 해상도, 컬러 프로파일 등을 필요에 맞게 수정해서 새로운 이미지 파일로 변환시켜주는 프로그램이다.
세팅은 나스와 서버를 sshfs로 연결시키고 나스의 특정 디렉토리에 변경하고자 하는 이미지를 넣고 crontab으로 주기적으로 노멀라이저 프로그램 스크립트를 실행시켜 다시 변환된 이미지를
나스에 저장한다.

-   기존엔 이미지 하나씩 작업하는 로직을 짰었는데 Multiprocessing 기술을 접하고 적용시켰더니
    각 이미지당 2분정도, 10개 작업시 20분정도 걸리는 작업을 5분 정도로 크게 줄일 수 있었다.

기여도 : 100%

### 프로그램 설명

1.  필요 프로그램
    Python3, Pillow

2.  Directory 설명
    a. command => normalizer.py

         1. 다른 파일들은 멀티프로세싱 등 테스트를 위한 파일이라 이것만 신경쓰시면 됩니다.
         2. 비율에 따른 사이즈별 이미지(size), 웹용 이미지 (main), 이미지가 72dpi라면 300dpi로 업스케일링된 이미지(300dpi)로 변환이 됩니다. (size, main, 300dpi -> command 부분 참조)

    b. color_profiles : 변환 또는 체크에 사용되는 컬러 프로파일들이 있습니다.
    c. size_profiles : 이미지 사이즈별 픽셀, mm 단위 정보가 json으로 담겨있음(세로 이미지 기준)
    d. resource :

    1. 이미지를 변환할 원본파일을 이곳에 넣으면 됩니다.
    2. 이미지 파일명 규칙 : 작가*작품명*사이즈.jpg

     <!-- 아래의 디렉토리는 따로 만들지 않아도 스크립트를 돌리면 자동 생성된다. -->

    e. completion : 변환이 완료된 원본 이미지가 resource에서 이곳으로 옮겨집니다. 만약 변환실패시 resource에 그대로 남게됩니다
    f. 300dpi : 원본 해상도가 200dpi 이하일 때 300dpi로 변환된 이미지 파일 디렉토리
    g. size : 사이즈별 생성된 이미지 디렉토리(작품별 디렉토리, 300dpi 기준)
    h. main : 웹용 이미지 디렉토리(72dpi)
    i. log : crontab으로 돌아갈때 진행된 결과가 log로 남습니다. 변환이 안되거나 문제가 있을 경우 여기서 확인하시면 됩니다.

3.  Flow
    a. 스크립트가 resource 파일에 변환할 이미지가 있는지 파악해서 배열로 가져온다.
    없다면 스크립트가 종료된다.
    b. 멀티프로세싱 적용으로 동시에 변환이 진행이된다.
    Pool(processes=8) 부분에서 사용할 코어 수를 정할 수 있다.
    각 이미지별로 프로세스에서 converting_image_script()를 실행 시킨다.
    c. converting_image_script() 에서 이미지 파일이 아닌경우 해당 프로세스는 종료된다.
    get_img_info()로 resource 디렉토리에 있는 원본 정보를 읽어 온 후
    make_converted_image()에 담아 실행시킨다.
    d. make_converted_image()에서 check_availability_image()로 해당 이미지가 사용 가능 여부를 판단하고
    Bullean으로 변환 가능 여부를 판단한다. false라면 종료
    e. True라면 웹용이미지, 사이즈별 이미지 생성을 하며 원본 파일은 completion으로 옮긴고 변환 완료를 내보낸다.

### History

#### 2022.04.14 Thu

\*웹용 이미지(main) -> 원본이 CMYK일 경우 RGB로 변환되어 저장되게 해달라는 디자인팀 요청

1. CMYK <-> RGB 변환시 색감 변환이 일어남
2. 포토샵에서 CMYK -> RGB 변환시 색감 차이가 크지 않지만 파이썬 Pillow의 Image.convert("RGB")로 변환 하면 색감 차이가 크게 남
3. 이미지 프로파일 (icc or icm)로 프로파일 변환을 시도함
4. 포토샵에선 RGB 변환시 sRGB-IEC61966-2.1.icc 프로파일을 다운받아 사용함
5. ImageCms.profileToProfile 로 기존 프로파일에서 상단의 프로파일로 변환 시킴
6. 이미지 resize에서는 Image.LANCZOS로 적용시켜 파일 최대한 손실 없게 설정함
7. 이렇게 적용시키니 정상적으로 rgb로 변환되면서 색감 변화도 육안으로는 크게 차이 안 나게 변환 되었다
8. 너무 어려웠다.

#### 2022.04.01 Fri

9. 같은 작품에 가로/세로 이미지가 있을 경우의 분류 규칙이 아직 정해지지 않았다.
   추후 논의 후 업데이트 할 예정.
